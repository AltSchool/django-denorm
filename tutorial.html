

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial &mdash; django-denorm v0.1 documentation</title>
    <link rel="stylesheet" href="static/default.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="django-denorm v0.1 documentation" href="index.html" />
    <link rel="next" title="Reference" href="reference.html" />
    <link rel="prev" title="Welcome to django-denorm’s documentation!" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="reference.html" title="Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to django-denorm’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">django-denorm v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<div class="section" id="counting-related-objects">
<h2>Counting related objects<a class="headerlink" href="#counting-related-objects" title="Permalink to this headline">¶</a></h2>
<p>Perhaps the most common use case for denormalization is to cache the number
of objects associated with an object instance through a ForeignKey.</p>
<p>So let&#8217;s say we are building a gallery application with models like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Gallery</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Picture</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">gallery</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Gallery</span><span class="p">)</span>
</pre></div>
</div>
<p>To calculate the number of pictures in a gallery, we would normally have a Django view with code similar to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">gallery</span> <span class="o">=</span> <span class="n">Gallery</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">number_of_pictures</span> <span class="o">=</span> <span class="n">gallery</span><span class="o">.</span><span class="n">picture_set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<p>However, this code will result in a COUNT query on the database for every tiem the page is viewed.</p>
<p>To speed this up we can cache the number of pictures inside the gallery:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">denorm</span> <span class="kn">import</span> <span class="n">CountField</span>

<span class="k">class</span> <span class="nc">Gallery</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">picture_count</span> <span class="o">=</span> <span class="n">CountField</span><span class="p">(</span><span class="s">&#39;picture_set&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Picture</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">gallery</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Gallery</span><span class="p">)</span>
</pre></div>
</div>
<p>This will incrementally update the number when we add and delete related objects.
Note that <tt class="docutils literal"><span class="pre">CountField</span></tt> updates are not lazy (like the callbacks described below), their value always gets updated immediately.</p>
</div>
<div class="section" id="creating-denormalized-fields-using-callback-functions">
<h2>Creating denormalized fields using callback functions<a class="headerlink" href="#creating-denormalized-fields-using-callback-functions" title="Permalink to this headline">¶</a></h2>
<p>A denormalized field can be created from a python function by using the <tt class="docutils literal"><span class="pre">&#64;denormalized</span></tt> decorator.
The decorator takes at least one argument: the database field type you want to use to store the computed
value. Any additional arguments will be passed into the constructor of the specified field when it is actually
created.</p>
<p>If you already use the <tt class="docutils literal"><span class="pre">&#64;property</span></tt> decorator that comes with python to make your computed values accessible
like attributes, you can often just replace <tt class="docutils literal"><span class="pre">&#64;property</span></tt> with <tt class="docutils literal"><span class="pre">&#64;denormalized(..)</span></tt> and you  won&#8217;t need to change any code outside your model.</p>
<p>Now whenever an instance of your model gets saved, the value stored in the field will get updated
with whatever value the decorated function returns.</p>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SomeModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># the other fields</span>

    <span class="nd">@denormalized</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">,</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">some_computation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="c"># your code</span>
       <span class="k">return</span> <span class="n">some_value</span>
</pre></div>
</div>
<p>in this example <tt class="docutils literal"><span class="pre">SomeModel</span></tt> will have a <tt class="docutils literal"><span class="pre">CharField</span></tt> named <tt class="docutils literal"><span class="pre">some_computation</span></tt>.</p>
<div class="section" id="adding-dependency-information">
<h3>Adding dependency information<a class="headerlink" href="#adding-dependency-information" title="Permalink to this headline">¶</a></h3>
<p>The above example will only work correctly if the return value of the
decorated function only depends on attributes of the same instance of the same
model it belongs to.</p>
<p>If the value somehow depends on information stored in other models, it will get
out of sync as those external information changes.</p>
<p>As this is a very undesirable effect, django-denorm provides a mechanism to
tell it what other model instances will effect the computed value. It provides
additional decorators to attach this dependency information to the function
before it gets turned into a field.</p>
<div class="section" id="depending-on-related-models">
<h4>Depending on related models<a class="headerlink" href="#depending-on-related-models" title="Permalink to this headline">¶</a></h4>
<p>In most cases your model probably contains a ForeignKey to some other model
(forward foreign key relationship), an other model has a ForeignKey to the
model containing the denormalized field (backward foreign key relationship)
or the two models are connected through a ManyToManyField,
and your function will somehow use the information in the related instance to
compute its return value.</p>
<p>This kind of dependency can be expressed like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SomeModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c"># the other fields</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;SomeOtherModel&#39;</span><span class="p">)</span>

    <span class="nd">@denormalized</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">,</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="nd">@depend_on_related</span><span class="p">(</span><span class="s">&#39;SomeOtherModel&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">some_computation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="c"># your code</span>
       <span class="k">return</span> <span class="n">some_value</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">&#64;depend_on_related</span></tt> decorator takes the related model as an argument in
the same was <tt class="docutils literal"><span class="pre">ForeignKey</span></tt> does, so you can use the same conventions here.
<tt class="docutils literal"><span class="pre">&#64;depend_on_related</span></tt> will then detect what kind (forward/backward/m2m)
of relationship the two
models have and update the value whenever the related instance of the other
model changes.</p>
<p>In case of an ambiguous relationship (maybe there are multiple foreign keys
to the related model) an error will be raised, and you&#8217;ll need to specify the
name of the ForeignKey to use like this:</p>
<div class="highlight-python"><pre>...
    @depend_on_related('SomeOtherModel',foreign_key='other')
...</pre>
</div>
<p>If this still is not enough information for django-denorm to pick the right
relation, there is probably a recursive dependency (on <tt class="docutils literal"><span class="pre">self</span></tt>).
In that you also need to specify the direction of the relation:</p>
<div class="highlight-python"><pre>...
    @depend_on_related('self',type='forward')
...</pre>
</div>
</div>
<div class="section" id="denormalizing-foreignkeys">
<h4>Denormalizing ForeignKeys<a class="headerlink" href="#denormalizing-foreignkeys" title="Permalink to this headline">¶</a></h4>
<p>If you wish to denormalize a ForeignKey (for example to cache a relationship that
is through another model), then your computation should return the primary key of
the related model. For example:</p>
<div class="highlight-python"><pre>class SomeOtherModel(models.Model):
    third_model = models.ForeignKey('ThirdModel')

class SomeModel(models.Model):
    # the other fields
    other = models.ForeignKey('SomeOtherModel')

   @denormalized(models.ForeignKey,to='ThirdModel',blank=True, null=True)
   @depend_on_related('SomeOtherModel')
   def third_model(self):
       return self.other.third_model.pk</pre>
</div>
</div>
</div>
<div class="section" id="callbacks-are-lazy">
<h3>Callbacks are lazy<a class="headerlink" href="#callbacks-are-lazy" title="Permalink to this headline">¶</a></h3>
<p>Your fields won&#8217;t get updated immediately after making changes to some data.
Instead potentially affected rows are marked as dirty in a special table and the
update will be done by the <tt class="docutils literal"><span class="pre">denorm.flush</span></tt> method.</p>
<div class="section" id="post-request-flushing">
<h4>Post-request flushing<a class="headerlink" href="#post-request-flushing" title="Permalink to this headline">¶</a></h4>
<p>The easiest way to call <tt class="docutils literal"><span class="pre">denorm.flush</span></tt> is to simply do it after every completed request.
This can be accomplished by adding <tt class="docutils literal"><span class="pre">DenormMiddleware</span></tt> to <tt class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></tt> in your <tt class="docutils literal"><span class="pre">settings.py</span></tt>:</p>
<div class="highlight-python"><pre>MIDDLEWARE_CLASSES = (
...
    'django.middleware.transaction.TransactionMiddleware',
    'denorm.middleware.DenormMiddleware',
...
)</pre>
</div>
<p>As shown in the example, I recommend to place <tt class="docutils literal"><span class="pre">DenormMiddleware</span></tt> right after <tt class="docutils literal"><span class="pre">TransactionMiddleware</span></tt>.</p>
</div>
<div class="section" id="using-the-daemon">
<h4>Using the daemon<a class="headerlink" href="#using-the-daemon" title="Permalink to this headline">¶</a></h4>
<p>If the above solution causes problem like slowing the webserver down because
<tt class="docutils literal"><span class="pre">denorm.flush</span></tt> takes to much time to complete, you can use a daemon to update the data.
The daemon will check for dirty rows in regular intervals and update them as necessary.
To run the daemon with an interval of 10 seconds run:</p>
<div class="highlight-python"><pre>./manage.py denorm_daemon 10</pre>
</div>
<p>The command will print the daemons pid and then detach itself from the terminal.</p>
</div>
</div>
</div>
<div class="section" id="final-steps">
<h2>Final steps<a class="headerlink" href="#final-steps" title="Permalink to this headline">¶</a></h2>
<p>Now that the models contain all information needed for the denormalization to work,
we need to do some final steps to make the database use it. As django-denorm uses triggers,
those have to be created in the database with:</p>
<div class="highlight-python"><pre>./manage.py denorm_init</pre>
</div>
<p>This has to be redone after every time you make changes to denormalized fields.</p>
</div>
<div class="section" id="testing-denormalized-apps">
<h2>Testing denormalized apps<a class="headerlink" href="#testing-denormalized-apps" title="Permalink to this headline">¶</a></h2>
<p>When testing a denormalized app you will need to instal the triggers in the setUp method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">denorm</span> <span class="kn">import</span> <span class="n">denorms</span>

<span class="k">class</span> <span class="nc">TestDenormalisation</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">denorms</span><span class="o">.</span><span class="n">install_triggers</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial</a><ul>
<li><a class="reference internal" href="#counting-related-objects">Counting related objects</a></li>
<li><a class="reference internal" href="#creating-denormalized-fields-using-callback-functions">Creating denormalized fields using callback functions</a><ul>
<li><a class="reference internal" href="#adding-dependency-information">Adding dependency information</a><ul>
<li><a class="reference internal" href="#depending-on-related-models">Depending on related models</a></li>
<li><a class="reference internal" href="#denormalizing-foreignkeys">Denormalizing ForeignKeys</a></li>
</ul>
</li>
<li><a class="reference internal" href="#callbacks-are-lazy">Callbacks are lazy</a><ul>
<li><a class="reference internal" href="#post-request-flushing">Post-request flushing</a></li>
<li><a class="reference internal" href="#using-the-daemon">Using the daemon</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#final-steps">Final steps</a></li>
<li><a class="reference internal" href="#testing-denormalized-apps">Testing denormalized apps</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to django-denorm&#8217;s documentation!</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="reference.html"
                        title="next chapter">Reference</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="sources/tutorial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="reference.html" title="Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to django-denorm’s documentation!"
             >previous</a> |</li>
        <li><a href="index.html">django-denorm v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, Christian Schilling.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>